<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MammoChat ‚Äî Your Breast Cancer Journey Companion</title>
    <meta name="description" content="I'm here to support you on your breast cancer journey">
    <meta name="theme-color" content="#ec4899">
    <style>
        :root {
            --bg: #fffbfc;
            --bg-alt: #ffffff;
            --fg: #1a1a1a;
            --fg-soft: #4a4a4a;
            --dim: #888;
            --accent: #db2777;
            --accent-soft: rgba(219, 39, 119, 0.08);
            --accent-glow: rgba(236, 72, 153, 0.2);
            --border: #fce7f3;
            --card: #ffffff;
            --shadow: 0 4px 24px rgba(219, 39, 119, 0.08);
            --warm: #f9a8d4;
            --warm-soft: rgba(249, 168, 212, 0.2);
            --warn: #f59e0b;
            --warn-soft: rgba(245, 158, 11, 0.1);
            --error: #ef4444;
            --error-soft: rgba(239, 68, 68, 0.1);
            --evo: #8b5cf6;
            --evo-soft: rgba(139, 92, 246, 0.1);
            --shop: #3b82f6;
            --shop-soft: rgba(59, 130, 246, 0.1);
            --hope: #10b981;
            --hope-soft: rgba(16, 185, 129, 0.1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0f0a0c;
                --bg-alt: #1a1015;
                --fg: #fdf2f8;
                --fg-soft: #f9a8d4;
                --dim: #9ca3af;
                --accent: #f472b6;
                --accent-soft: rgba(244, 114, 182, 0.12);
                --accent-glow: rgba(244, 114, 182, 0.25);
                --border: #2d1f26;
                --card: #1f1318;
                --shadow: 0 4px 24px rgba(0,0,0,0.4);
                --warm: #be185d;
                --warm-soft: rgba(190, 24, 93, 0.2);
                --warn-soft: rgba(245, 158, 11, 0.15);
                --error-soft: rgba(239, 68, 68, 0.15);
                --evo-soft: rgba(139, 92, 246, 0.15);
                --shop-soft: rgba(59, 130, 246, 0.15);
                --hope-soft: rgba(16, 185, 129, 0.15);
            }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: var(--bg);
            color: var(--fg);
            height: 100vh;
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
        }

        /* Header */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: var(--bg-alt);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        @supports (backdrop-filter: blur(20px)) {
            header {
                background: transparent;
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
            }
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-symbol {
            font-size: 24px;
            font-weight: 300;
            color: var(--accent);
        }

        .logo-text {
            font-size: 16px;
            font-weight: 600;
        }

        .logo-text span { color: var(--accent); }

        .logo-badge {
            font-size: 10px;
            padding: 4px 8px;
            background: var(--accent-soft);
            border: 1px solid var(--accent);
            border-radius: 6px;
            color: var(--accent);
            font-weight: 500;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        select {
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--fg);
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        select:hover { border-color: var(--accent); }
        select:focus { outline: none; border-color: var(--accent); }

        .dcis-badge {
            display: none;
            padding: 8px 14px;
            background: var(--warn-soft);
            border: 1px solid var(--warn);
            border-radius: 10px;
            color: var(--warn);
            font-size: 12px;
            font-weight: 500;
        }

        .dcis-badge.show { display: flex; align-items: center; gap: 6px; }

        /* Main */
        main {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* Messages */
        .messages {
            flex: 1;
            padding: 24px;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
        }

        .message {
            margin-bottom: 24px;
            animation: fadeUp 0.3s ease-out;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .msg-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .msg-role {
            font-size: 13px;
            font-weight: 600;
        }

        .msg-role.user { color: var(--fg); }
        .msg-role.assistant { color: var(--accent); }

        .msg-tag {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: 500;
        }

        .msg-tag.dcis { background: var(--warn-soft); color: var(--warn); border: 1px solid var(--warn); }
        .msg-tag.mcode { background: var(--accent-soft); color: var(--accent); border: 1px solid var(--accent); }
        .msg-tag.evo { background: var(--evo-soft); color: var(--evo); border: 1px solid var(--evo); }
        .msg-tag.shop { background: var(--shop-soft); color: var(--shop); border: 1px solid var(--shop); }
        .msg-tag.hope { background: var(--hope-soft); color: var(--hope); border: 1px solid var(--hope); }
        .msg-tag.support { background: var(--accent-soft); color: var(--accent); border: 1px solid var(--accent); }
        .msg-tag.question { background: var(--warm-soft); color: var(--accent); border: 1px solid var(--warm); }
        .msg-tag.trials { background: var(--shop-soft); color: var(--shop); border: 1px solid var(--shop); }
        .msg-tag.learn { background: var(--evo-soft); color: var(--evo); border: 1px solid var(--evo); }
        .msg-tag.listening { background: var(--accent-soft); color: var(--accent); border: 1px solid var(--accent); }

        .msg-content {
            font-size: 15px;
            line-height: 1.6;
            color: var(--fg-soft);
            padding: 16px 20px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
        }

        .msg-content.assistant {
            border-left: 3px solid var(--accent);
        }

        .evidence {
            margin-top: 12px;
            padding: 12px 16px;
            background: var(--bg);
            border-radius: 12px;
        }

        .evidence-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 6px;
        }

        .evidence-ref {
            font-size: 12px;
            color: var(--dim);
            font-family: 'SF Mono', Monaco, monospace;
            padding: 2px 0;
        }

        .mcode-bar {
            margin-top: 12px;
            padding: 8px 12px;
            background: var(--accent-soft);
            border-radius: 8px;
            font-size: 11px;
            font-family: 'SF Mono', Monaco, monospace;
            color: var(--accent);
        }

        /* Welcome */
        .welcome {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 48px 24px;
            max-width: 640px;
            margin: 0 auto;
        }

        .welcome-heart {
            font-size: 64px;
            margin-bottom: 24px;
            animation: pulse-heart 2s ease-in-out infinite;
        }

        @keyframes pulse-heart {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        .welcome h1 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 16px;
            line-height: 1.3;
        }

        .welcome h1 span { color: var(--accent); }

        .welcome-message {
            font-size: 18px;
            line-height: 1.7;
            color: var(--fg-soft);
            margin-bottom: 40px;
        }

        .welcome-features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            width: 100%;
            margin-bottom: 40px;
        }

        @media (max-width: 500px) {
            .welcome-features { grid-template-columns: 1fr; }
        }

        .feature-card {
            padding: 20px 24px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            text-align: left;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .feature-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .feature-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .feature-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--fg);
            margin-bottom: 4px;
        }

        .feature-desc {
            font-size: 12px;
            color: var(--dim);
            line-height: 1.5;
        }

        .welcome-prompt {
            padding: 16px 24px;
            background: var(--accent-soft);
            border: 1px solid var(--accent);
            border-radius: 16px;
            margin-bottom: 16px;
        }

        .welcome-prompt-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .welcome-prompt-text {
            font-size: 14px;
            color: var(--fg-soft);
            font-style: italic;
        }

        .welcome-footer {
            font-size: 13px;
            color: var(--dim);
            margin-bottom: 20px;
        }

        .welcome-footer strong { color: var(--accent); }

        .disclaimer {
            padding: 12px 20px;
            background: var(--warm-soft);
            border: 1px solid var(--warm);
            border-radius: 12px;
            font-size: 12px;
            color: var(--fg-soft);
            max-width: 400px;
        }

        .disclaimer strong { color: var(--accent); }

        /* Input */
        .input-area {
            padding: 16px 24px 24px;
            background: var(--bg-alt);
            border-top: 1px solid var(--border);
        }

        .input-wrap {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .input-field {
            width: 100%;
            padding: 16px 60px 16px 20px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            color: var(--fg);
            font-size: 15px;
            font-family: inherit;
            resize: none;
            transition: all 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }

        .send-btn {
            position: absolute;
            right: 12px;
            bottom: 12px;
            width: 40px;
            height: 40px;
            background: var(--accent);
            border: none;
            border-radius: 12px;
            color: #000;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px var(--accent-glow);
        }

        /* Tab Navigation */
        .tab-nav {
            position: fixed;
            bottom: 100px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .tab-btn {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--dim);
            font-size: 11px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow);
        }

        .tab-btn:hover { border-color: var(--accent); color: var(--accent); }
        .tab-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }
        .tab-btn.evo { border-color: var(--evo); }
        .tab-btn.evo:hover, .tab-btn.evo.active { background: var(--evo); color: #fff; }
        .tab-btn.shop { border-color: var(--shop); }
        .tab-btn.shop:hover, .tab-btn.shop.active { background: var(--shop); color: #fff; }

        /* Panels */
        .panel { display: none; }
        .panel.active { display: flex; flex-direction: column; flex: 1; }

        /* EVO Panel */
        .evo-content {
            padding: 24px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .evo-header {
            font-size: 20px;
            font-weight: 600;
            color: var(--evo);
            margin-bottom: 24px;
        }

        .evo-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        .evo-stat {
            padding: 24px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            text-align: center;
        }

        .evo-stat .value {
            font-size: 36px;
            font-weight: 600;
            color: var(--evo);
        }

        .evo-stat .label {
            font-size: 11px;
            color: var(--dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 4px;
        }

        .evo-list {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
        }

        .evo-item {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }

        .evo-item:last-child { border-bottom: none; }
        .evo-item .time { color: var(--dim); margin-right: 12px; }
        .evo-item .learned { color: var(--evo); }

        /* SHOP Panel */
        .shop-content {
            padding: 24px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .shop-header {
            font-size: 20px;
            font-weight: 600;
            color: var(--shop);
            margin-bottom: 24px;
        }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        @media (max-width: 600px) {
            .shop-grid { grid-template-columns: 1fr; }
        }

        .shop-card {
            padding: 28px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 20px;
            transition: all 0.3s;
        }

        .shop-card:hover {
            border-color: var(--shop);
            transform: translateY(-4px);
            box-shadow: var(--shadow);
        }

        .shop-card h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--shop);
            margin-bottom: 8px;
        }

        .shop-card p {
            font-size: 13px;
            color: var(--dim);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .shop-card .price {
            font-size: 24px;
            font-weight: 600;
            color: var(--fg);
        }

        .shop-card .tier {
            font-size: 11px;
            color: var(--dim);
            margin-top: 4px;
        }

        .shop-card button {
            margin-top: 16px;
            width: 100%;
            padding: 12px;
            background: var(--shop);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .shop-card button:hover {
            transform: scale(1.02);
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <span class="logo-symbol">üíó</span>
            <span class="logo-text">Mammo<span>Chat</span></span>
            <span class="logo-badge">mCODE Verified</span>
        </div>
        <div class="header-controls">
            <select id="histology" onchange="updateContext()">
                <option value="UNKNOWN">Histology: ?</option>
                <option value="DCIS">DCIS</option>
                <option value="INVASIVE">Invasive</option>
            </select>
            <select id="phase" onchange="updateContext()">
                <option value="SCREENING">Screening</option>
                <option value="DIAGNOSIS">Diagnosis</option>
                <option value="TREATMENT">Treatment</option>
                <option value="SURVIVORSHIP">Survivorship</option>
            </select>
            <div class="dcis-badge" id="dcis-badge">‚ö†Ô∏è DCIS ‚â† Invasive</div>
        </div>
    </header>

    <main>
        <!-- CHAT Panel -->
        <div class="panel active" id="panel-chat">
            <div class="messages" id="messages"></div>
        </div>

        <!-- EVO Panel -->
        <div class="panel" id="panel-evo">
            <div class="evo-content">
                <div class="evo-header">‚óà Learning Ledger</div>
                <div class="evo-stats">
                    <div class="evo-stat">
                        <div class="value">528</div>
                        <div class="label">Axioms</div>
                    </div>
                    <div class="evo-stat">
                        <div class="value">38</div>
                        <div class="label">IDFs</div>
                    </div>
                    <div class="evo-stat">
                        <div class="value">20K+</div>
                        <div class="label">Encounters</div>
                    </div>
                </div>
                <div class="evo-list">
                    <div class="evo-item"><span class="time">2026-01-30</span><span class="learned">‚Üí Learned: DCIS ‚â† Invasive distinction (Minh feedback)</span></div>
                    <div class="evo-item"><span class="time">2026-01-29</span><span class="learned">‚Üí Learned: mCODE embedding for histology</span></div>
                    <div class="evo-item"><span class="time">2026-01-28</span><span class="learned">‚Üí Learned: BI-RADS 5ed classification</span></div>
                    <div class="evo-item"><span class="time">2026-01-27</span><span class="learned">‚Üí Learned: NCCN 2024 treatment pathways</span></div>
                </div>
            </div>
        </div>

        <!-- SHOP Panel -->
        <div class="panel" id="panel-shop">
            <div class="shop-content">
                <div class="shop-header">‚óÜ MammoChat Services</div>
                <div class="shop-grid">
                    <div class="shop-card">
                        <h3>Personal</h3>
                        <p>Patient education, risk assessment, community support</p>
                        <div class="price">Free</div>
                        <div class="tier">COMMUNITY tier</div>
                        <button>Active</button>
                    </div>
                    <div class="shop-card">
                        <h3>Clinical</h3>
                        <p>Epic EHR integration, mCODE extraction, clinical decision support</p>
                        <div class="price">$50K/yr</div>
                        <div class="tier">BUSINESS tier</div>
                        <button>Contact Sales</button>
                    </div>
                    <div class="shop-card">
                        <h3>TrialsChat</h3>
                        <p>Clinical trials matching, eligibility parsing, site finder</p>
                        <div class="price">$25K/yr</div>
                        <div class="tier">BUSINESS tier</div>
                        <button>Coming Q2</button>
                    </div>
                    <div class="shop-card">
                        <h3>VaaS Enterprise</h3>
                        <p>Validation as a Service, DETROS compliance, custom domains</p>
                        <div class="price">$100K/yr</div>
                        <div class="tier">ENTERPRISE tier</div>
                        <button>Contact Sales</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn evo" onclick="showPanel('evo')">EVO</button>
        <button class="tab-btn active" onclick="showPanel('chat')">CHAT</button>
        <button class="tab-btn shop" onclick="showPanel('shop')">SHOP</button>
    </div>

    <!-- Input -->
    <div class="input-area">
        <div class="input-wrap">
            <textarea class="input-field" id="input" rows="1" placeholder="What's on your mind? I'm here to help..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();send()}"></textarea>
            <button class="send-btn" onclick="send()">‚Üë</button>
        </div>
    </div>

    <script>
        const MCODE = {
            DCIS: { snomed: '109886000', desc: 'Ductal carcinoma in situ', chemo: false },
            INVASIVE: { snomed: '254837009', desc: 'Invasive breast carcinoma', chemo: true },
            UNKNOWN: { snomed: '?', desc: 'Histology pending', chemo: null }
        };

        let ctx = { histology: 'UNKNOWN', phase: 'SCREENING' };
        let messages = [];

        function showPanel(panel) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('panel-' + panel).classList.add('active');
            event.target.classList.add('active');
        }

        function updateContext() {
            ctx.histology = document.getElementById('histology').value;
            ctx.phase = document.getElementById('phase').value;
            document.getElementById('dcis-badge').classList.toggle('show', ctx.histology === 'DCIS');
        }

        function render() {
            const el = document.getElementById('messages');
            if (!messages.length) {
                el.innerHTML = `
                    <div class="welcome">
                        <div class="welcome-heart">üíó</div>
                        <h1>I'm here to support you on your <span>breast cancer journey</span></h1>
                        <p class="welcome-message">
                            I understand this is a difficult time. Whether you're newly diagnosed,
                            in treatment, or in survivorship ‚Äî I'm here to walk alongside you
                            every step of the way.
                        </p>
                        <div class="welcome-features">
                            <div class="feature-card">
                                <div class="feature-icon">üî¨</div>
                                <div class="feature-title">Find Clinical Trials</div>
                                <div class="feature-desc">Discover trials matched to your specific cancer type and situation</div>
                            </div>
                            <div class="feature-card">
                                <div class="feature-icon">üë•</div>
                                <div class="feature-title">Connect with Peers</div>
                                <div class="feature-desc">Find others who share your journey and understand what you're going through</div>
                            </div>
                            <div class="feature-card">
                                <div class="feature-icon">üíä</div>
                                <div class="feature-title">Navigate Treatment</div>
                                <div class="feature-desc">Understand your options with evidence-based information</div>
                            </div>
                            <div class="feature-card">
                                <div class="feature-icon">üí™</div>
                                <div class="feature-title">Make Informed Decisions</div>
                                <div class="feature-desc">Feel empowered with knowledge about your care</div>
                            </div>
                        </div>
                        <div class="welcome-prompt">
                            <div class="welcome-prompt-label">Try asking me</div>
                            <div class="welcome-prompt-text">"I'm 52, ER+/HER2-, and want to understand my treatment options"</div>
                        </div>
                        <p class="welcome-footer">I remember our conversations and your <strong>unique situation</strong></p>
                        <div class="disclaimer">
                            <strong>Educational support only</strong> ‚Äî Always consult your care team for medical decisions
                        </div>
                    </div>
                `;
                return;
            }

            el.innerHTML = messages.map(m => {
                const tags = (m.tags || []).map(t => `<span class="msg-tag ${t.toLowerCase()}">${t}</span>`).join('');
                const evidence = m.evidence?.length ? `
                    <div class="evidence">
                        <div class="evidence-title">Evidence</div>
                        ${m.evidence.map(e => `<div class="evidence-ref">${e}</div>`).join('')}
                    </div>
                ` : '';
                const mcode = m.mcode ? `<div class="mcode-bar">mCODE: ${m.mcode.snomed} | ${m.mcode.phase}</div>` : '';

                return `
                    <div class="message">
                        <div class="msg-header">
                            <span class="msg-role ${m.role}">${m.role === 'user' ? 'You' : 'MammoChat'}</span>
                            ${tags}
                        </div>
                        <div class="msg-content ${m.role}">
                            ${m.content}
                            ${evidence}
                            ${mcode}
                        </div>
                    </div>
                `;
            }).join('');

            el.scrollTop = el.scrollHeight;
        }

        function respond(text) {
            const t = text.toLowerCase();
            const h = ctx.histology;
            const mc = { snomed: MCODE[h].snomed, phase: ctx.phase };

            if (t.includes('chemo') && h === 'DCIS') {
                return {
                    content: `I understand you're asking about chemotherapy. Here's something important that many women find reassuring: <strong>DCIS is non-invasive</strong>, which means it hasn't spread beyond the milk ducts.<br><br>The good news is that <strong>chemotherapy is typically not needed for DCIS</strong>. Treatment usually involves surgery (lumpectomy or mastectomy), sometimes followed by radiation. Your care team will discuss what's right for your specific situation.`,
                    tags: ['DCIS', 'HOPE'],
                    evidence: ['NCCN Guidelines 2024', 'mCODE Standard', 'Your Care Team'],
                    mcode: mc
                };
            }

            if (t.includes('chemo') && h === 'INVASIVE') {
                return {
                    content: `I hear you're thinking about chemotherapy. With invasive breast cancer, chemotherapy <em>may</em> be part of your treatment plan, depending on several factors:<br><br>‚Ä¢ Stage and grade of your cancer<br>‚Ä¢ Hormone receptor status (ER/PR)<br>‚Ä¢ HER2 status<br>‚Ä¢ Genomic test results (like Oncotype DX)<br><br>I know this feels like a lot. Your oncologist will help you understand if chemo is recommended for your specific situation. Would you like me to explain any of these factors?`,
                    tags: ['SUPPORT'],
                    evidence: ['NCCN Guidelines 2024', 'mCODE Standard'],
                    mcode: mc
                };
            }

            if (t.includes('chemo') && h === 'UNKNOWN') {
                return {
                    content: `I'd like to give you the most accurate information I can about chemotherapy. To do that, I need to know a bit more about your diagnosis.<br><br>Could you select your histology type above? The answer is quite different for DCIS (non-invasive) versus invasive cancer. If you're not sure, that's okay ‚Äî your pathology report will have this information, or we can talk about both scenarios.`,
                    tags: ['QUESTION'],
                    evidence: ['mCODE requires histology for accurate guidance'],
                    mcode: mc
                };
            }

            if (t.includes('trial')) {
                return {
                    content: `Clinical trials can be a wonderful option ‚Äî they give you access to cutting-edge treatments while contributing to research that helps others. üí™<br><br>Based on your profile, I can help match you with relevant trials from ClinicalTrials.gov. Would you like me to search for trials that match your specific cancer type and location?`,
                    tags: ['TRIALS'],
                    evidence: ['ClinicalTrials.gov', 'Verified matching'],
                    mcode: mc
                };
            }

            if (t.includes('scared') || t.includes('afraid') || t.includes('worried') || t.includes('anxious')) {
                return {
                    content: `What you're feeling is completely normal. A breast cancer diagnosis brings up so many emotions ‚Äî fear, uncertainty, grief, even anger. These feelings are valid.<br><br>Many women find it helpful to:<br>‚Ä¢ Connect with others who've been through this<br>‚Ä¢ Take things one step at a time<br>‚Ä¢ Focus on what you <em>can</em> control<br>‚Ä¢ Lean on your support system<br><br>I'm here whenever you need to talk. üíó`,
                    tags: ['SUPPORT'],
                    evidence: ['You are not alone'],
                    mcode: mc
                };
            }

            if (t.includes('birads') || t.includes('bi-rads')) {
                return {
                    content: `BI-RADS is the standardized way radiologists describe mammogram findings. Here's what the categories mean:<br><br>‚Ä¢ <strong>0</strong> ‚Äî Need more imaging<br>‚Ä¢ <strong>1</strong> ‚Äî Normal, nothing concerning<br>‚Ä¢ <strong>2</strong> ‚Äî Benign finding<br>‚Ä¢ <strong>3</strong> ‚Äî Probably benign (<2% cancer risk)<br>‚Ä¢ <strong>4</strong> ‚Äî Suspicious (2-95% risk, biopsy usually recommended)<br>‚Ä¢ <strong>5</strong> ‚Äî Highly suspicious (>95% risk)<br>‚Ä¢ <strong>6</strong> ‚Äî Known cancer<br><br>Which category would you like me to explain more?`,
                    tags: ['LEARN'],
                    evidence: ['ACR BI-RADS 5th Edition'],
                    mcode: mc
                };
            }

            return {
                content: `Thank you for sharing that with me. I'm here to help you understand "${text}".<br><br>Could you tell me a bit more about what you'd like to know? I'm listening. üíó`,
                tags: ['LISTENING'],
                evidence: ['Your journey, your pace'],
                mcode: mc
            };
        }

        function send() {
            const input = document.getElementById('input');
            const text = input.value.trim();
            if (!text) return;

            // Switch to chat panel
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById('panel-chat').classList.add('active');

            const mc = { snomed: MCODE[ctx.histology].snomed, phase: ctx.phase };
            messages.push({ role: 'user', content: text, mcode: mc });

            const resp = respond(text);
            messages.push({ role: 'assistant', ...resp });

            input.value = '';
            render();
        }

        render();
    </script>
</body>
</html>
