<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOLDINGS | DEXTER Private</title>
    <style>
        :root {
            --bg: #0a0a0a;
            --fg: #fff;
            --accent: #ff6b35;
            --dim: #888;
            --private: #ff6b35;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: ui-monospace, 'SF Mono', 'Cascadia Code', Menlo, monospace;
            background: var(--bg);
            color: var(--fg);
            min-height: 100vh;
        }
        .topnav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            border-bottom: 1px solid #333;
        }
        .topnav-brand {
            font-size: 0.9rem;
            letter-spacing: 0.2em;
            color: var(--private);
            text-decoration: none;
        }
        .topnav-links { display: flex; gap: 2rem; }
        .topnav-links a {
            color: var(--dim);
            text-decoration: none;
            font-size: 0.85rem;
        }
        .topnav-links a:hover { color: var(--accent); }
        .topnav-links a.active { color: var(--fg); }
        .private-badge {
            background: var(--private);
            color: var(--bg);
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
            letter-spacing: 0.1em;
            margin-left: 0.5rem;
        }

        .hero {
            text-align: center;
            padding: 3rem 2rem;
        }
        h1 {
            font-size: 2rem;
            font-weight: 300;
            letter-spacing: 0.3em;
            margin-bottom: 0.5rem;
        }
        .tagline {
            color: var(--dim);
            font-size: 0.9rem;
            letter-spacing: 0.1em;
        }
        .axiom-box {
            color: var(--accent);
            font-size: 0.85rem;
            padding: 1rem;
            border: 1px solid var(--accent);
            margin-top: 1rem;
            display: inline-block;
            max-width: 600px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
            max-width: 600px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        .stat {
            padding: 1rem;
            border: 1px solid #333;
            text-align: center;
        }
        .stat-value {
            font-size: 1.5rem;
            color: var(--accent);
        }
        .stat-label {
            font-size: 0.65rem;
            color: var(--dim);
            letter-spacing: 0.1em;
        }

        .section {
            padding: 2rem;
            border-top: 1px solid #333;
        }
        .section-title {
            text-align: center;
            font-size: 0.85rem;
            letter-spacing: 0.3em;
            color: var(--dim);
            margin-bottom: 2rem;
        }

        .tree {
            max-width: 900px;
            margin: 0 auto;
        }
        .tree-node {
            border: 1px solid #333;
            margin-bottom: 0.5rem;
            margin-left: var(--depth, 0);
        }
        .tree-node:hover { border-color: var(--accent); }
        .tree-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background: rgba(255,255,255,0.02);
        }
        .tree-header:hover { background: rgba(255,255,255,0.05); }
        .tree-header h3 {
            font-size: 0.85rem;
            letter-spacing: 0.1em;
        }
        .tree-header .meta {
            color: var(--dim);
            font-size: 0.7rem;
        }
        .tree-content {
            padding: 0 1rem 1rem;
            display: none;
        }
        .tree-content.open { display: block; }
        .tree-axiom {
            color: var(--dim);
            font-size: 0.8rem;
            line-height: 1.5;
            padding: 0.5rem;
            border-left: 2px solid var(--accent);
            margin-bottom: 0.5rem;
        }
        .tree-constraints {
            font-size: 0.7rem;
            color: var(--dim);
            margin-top: 0.5rem;
        }
        .tree-constraints li {
            margin-left: 1rem;
            margin-top: 0.25rem;
        }

        .loading {
            text-align: center;
            color: var(--dim);
            padding: 2rem;
        }
        .error {
            color: #ff4444;
        }

        footer {
            text-align: center;
            padding: 2rem;
            border-top: 1px solid #333;
            color: var(--dim);
            font-size: 0.7rem;
        }
    </style>
</head>
<body>
    <nav class="topnav">
        <a href="../" class="topnav-brand">DEXTER<span class="private-badge">PRIVATE</span></a>
        <div class="topnav-links">
            <a href="../STORE/">Store</a>
            <a href="../EVIDENCE/">Evidence</a>
            <a href="./" class="active">Holdings</a>
        </div>
    </nav>

    <section class="hero">
        <h1>HOLDINGS</h1>
        <p class="tagline">CANON Aggregator | Reads CANON.md Tree</p>
        <div class="axiom-box" id="root-axiom">Loading CANON.md...</div>
    </section>

    <div class="stats" id="stats">
        <div class="stat">
            <div class="stat-value" id="stat-canon">-</div>
            <div class="stat-label">CANON.md</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="stat-children">-</div>
            <div class="stat-label">CHILDREN</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="stat-depth">-</div>
            <div class="stat-label">MAX DEPTH</div>
        </div>
    </div>

    <section class="section">
        <h2 class="section-title">CANON TREE</h2>
        <div class="tree" id="tree">
            <p class="loading">Reading CANON.md files from GitHub...</p>
        </div>
    </section>

    <footer>
        <p>HOLDINGS APP | Reads CANON.md | Aggregates Tree | hadleylab-dexter/hadleylab</p>
    </footer>

    <script>
        const REPO = 'hadleylab-dexter/hadleylab';
        const BASE_PATH = 'HOLDINGS';
        const API = 'https://api.github.com';

        let canonCount = 0;
        let maxDepth = 0;

        async function fetchCanon(path) {
            const url = `${API}/repos/${REPO}/contents/${path}/CANON.md`;
            try {
                const res = await fetch(url);
                if (!res.ok) return null;
                const data = await res.json();
                const content = atob(data.content);
                return parseCanon(content, path);
            } catch (e) {
                console.error(`Failed to fetch ${path}/CANON.md:`, e);
                return null;
            }
        }

        function parseCanon(content, path) {
            const lines = content.split('\n');
            const canon = {
                title: path.split('/').pop(),
                axiom: '',
                axioms: [],
                children: [],
                constraints: []
            };

            let section = '';
            for (const line of lines) {
                if (line.startsWith('# ')) {
                    canon.title = line.slice(2).trim();
                } else if (line.match(/^## Axioms?$/i)) {
                    section = 'axiom';
                } else if (line.match(/^## Children$/i)) {
                    section = 'children';
                } else if (line.match(/^## Constraints?$/i)) {
                    section = 'constraints';
                } else if (line.startsWith('## ')) {
                    section = '';
                } else if (section === 'axiom') {
                    if (line.startsWith('**') && line.includes('**')) {
                        canon.axiom = line.replace(/\*\*/g, '').replace(/=/, 'â†’').trim();
                    } else if (line.match(/^\d+\./)) {
                        canon.axioms.push(line.replace(/^\d+\.\s*\*\*([^*]+)\*\*:?\s*/, '$1: ').trim());
                    }
                } else if (section === 'children' && line.startsWith('- ')) {
                    const match = line.match(/- ([^/\s]+)\/?/);
                    if (match) canon.children.push(match[1]);
                } else if (section === 'constraints' && line.startsWith('- ')) {
                    canon.constraints.push(line.slice(2).trim());
                }
            }
            return canon;
        }

        async function buildTree(path, depth = 0) {
            const canon = await fetchCanon(path);
            if (!canon) return null;

            canonCount++;
            maxDepth = Math.max(maxDepth, depth);

            const node = { path, canon, children: [], depth };

            // Fetch children in parallel
            const childPromises = canon.children.map(child =>
                buildTree(`${path}/${child}`, depth + 1)
            );
            const childNodes = await Promise.all(childPromises);
            node.children = childNodes.filter(n => n !== null);

            return node;
        }

        function renderNode(node, container) {
            const el = document.createElement('div');
            el.className = 'tree-node';
            el.style.setProperty('--depth', `${node.depth * 1.5}rem`);

            const childCount = node.children.length;
            const hasContent = node.canon.axiom || node.canon.constraints.length > 0;

            el.innerHTML = `
                <div class="tree-header" onclick="this.nextElementSibling.classList.toggle('open')">
                    <h3>${node.canon.title}</h3>
                    <span class="meta">${childCount > 0 ? childCount + ' children' : 'leaf'}</span>
                </div>
                <div class="tree-content">
                    ${node.canon.axiom ? `<div class="tree-axiom">${node.canon.axiom}</div>` : ''}
                    ${node.canon.constraints.length > 0 ? `
                        <div class="tree-constraints">
                            <strong>Constraints:</strong>
                            <ul>${node.canon.constraints.map(c => `<li>${c}</li>`).join('')}</ul>
                        </div>
                    ` : ''}
                </div>
            `;
            container.appendChild(el);

            // Render children
            for (const child of node.children) {
                renderNode(child, container);
            }
        }

        async function init() {
            const treeContainer = document.getElementById('tree');

            try {
                const tree = await buildTree(BASE_PATH);

                if (tree) {
                    // Update stats
                    document.getElementById('root-axiom').textContent =
                        tree.canon.axiom || 'HOLDINGS = IP governance structure';
                    document.getElementById('stat-canon').textContent = canonCount;
                    document.getElementById('stat-children').textContent = tree.canon.children.length;
                    document.getElementById('stat-depth').textContent = maxDepth;

                    // Render tree
                    treeContainer.innerHTML = '';
                    renderNode(tree, treeContainer);
                } else {
                    treeContainer.innerHTML = '<p class="loading error">Could not load HOLDINGS/CANON.md</p>';
                }
            } catch (e) {
                treeContainer.innerHTML = `<p class="loading error">Error: ${e.message}</p>`;
            }
        }

        init();
    </script>
</body>
</html>
